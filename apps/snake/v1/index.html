<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="utf-8" />
		<title>Snake</title>
		<style>
			#mycanvas {
				background-color: white;
				margin-top: -300px;
				margin-left: -300px;
				position: absolute;
				left: 50%;
				top: 50%;
                border: 3px solid black;
			}
		</style>
	</head>
	<body>
		<canvas id="mycanvas" height="600" width="600">O seu browser não suporta este elemento</canvas>
		<script>
			var canvas = document.getElementById("mycanvas");
			var ctx = canvas.getContext("2d");
            var alturaBloco = 12, larguraBloco = 12, time = 70, decrementoTempo = 2, estado, score = 0, recorde;

            function Bloco() {
                var x;
                var y;
                var direction = "right";
                
                this.desenha = function(){
                    ctx.fillRect(this.x, this.y, larguraBloco, alturaBloco);
                }
            
                this.atualiza = function(){
                    if(this.direction == "right")
                        this.x += larguraBloco;
                    else if(this.direction == "left")
                        this.x -= larguraBloco;
                    else if(this.direction == "down")
                        this.y += larguraBloco;
                    else if(this.direction == "up")
                        this.y -= larguraBloco;
                }
            }
            
            var estados = {
                telaInicial: 0,
                jogando: 1,
                perdeu: 2
            };
            
			var snake = {
                blocos: [],
                
                desenha: function(){
                    ctx.fillStyle = "black";
                    
                    for(var i = 0; i < this.blocos.length; i++)
                        this.blocos[i].desenha();
                },
                
                atualiza: function(){
                    for(var i = 0; i < this.blocos.length; i++)
                        this.blocos[i].atualiza();
                    
                    for(var i = this.blocos.length - 1; i > 0; i--){
                        if(this.blocos[i].direction != this.blocos[i-1].direction){
                            this.blocos[i].direction = this.blocos[i-1].direction;
                        }   
                    }
                    
                    var primeiroBloco = this.blocos[0];
                    
                    //Verifica se o alimento foi atingido
                    if(primeiroBloco.x + (larguraBloco / 2) >= comida.x && primeiroBloco.x + (larguraBloco / 2) <= comida.x + larguraBloco)
                        if(primeiroBloco.y + (alturaBloco / 2) >= comida.y && primeiroBloco.y + (alturaBloco / 2) <= comida.y + alturaBloco){
                            
                            score += Math.floor(comida.tempoRestante / 100);
                            comida.tempoRestante = -1;
                            this.insereBloco();
                            time -= decrementoTempo;
                        }
                    
                    //Verifica se a parede foi atingida                
                    if(primeiroBloco.x < 0 || primeiroBloco.x + larguraBloco > 600 || primeiroBloco.y < 0 || primeiroBloco.y + alturaBloco > 600)
                        estado = estados.perdeu;
                    
                    //Verifica se a cobra atingiu a si mesma
                    var tam = this.blocos.length
                    for(var i = 1; i < tam; i++){
                        var bloco = this.blocos[i];
                        if(primeiroBloco.x + (larguraBloco / 2) >= bloco.x && primeiroBloco.x + (larguraBloco / 2) <= bloco.x + larguraBloco)
                            if(primeiroBloco.y + (alturaBloco / 2) >= bloco.y && primeiroBloco.y + (alturaBloco / 2) <= bloco.y + alturaBloco)
                                estado = estados.perdeu;
                    }
                    
                    if(estado == estados.perdeu){
                        if(score > recorde){
                            localStorage.setItem("recorde-snake", score);
                            recorde = score;
                            score = -1;
                        }
                    }
                },
                
                insereBloco: function(){
                    var ultimoBloco = this.blocos[this.blocos.length - 1];
                    
                    if(ultimoBloco == null){
                        ultimoBloco = new Bloco();
                        ultimoBloco.direction = "right";
                        ultimoBloco.x = 300;
                        ultimoBloco.y = 300;
                    }
                        
                    
                    var newBloco = new Bloco();
                    newBloco.direction = ultimoBloco.direction;
                    
                    if(ultimoBloco.direction == "right"){
                        newBloco.x = ultimoBloco.x - larguraBloco;
                        newBloco.y = ultimoBloco.y;
                    }
                    else if(ultimoBloco.direction == "left"){
                        newBloco.x = ultimoBloco.x + larguraBloco;
                        newBloco.y = ultimoBloco.y;
                    }
                    else if(ultimoBloco.direction == "up"){
                        newBloco.x = ultimoBloco.x;
                        newBloco.y = ultimoBloco.y + alturaBloco;
                    }
                    else if(ultimoBloco.direction == "down"){
                        newBloco.x = ultimoBloco.x;
                        newBloco.y = ultimoBloco.y - alturaBloco;
                    }
                    
                    this.blocos.push(newBloco);
                },
                
                changeDirection: function(dir){
                    var primeiroBloco = this.blocos[0];
                    
                    if(dir == "up"){
                        if(primeiroBloco.direction == "left" || primeiroBloco.direction == "right")
                            primeiroBloco.direction = "up";
                    }
                    else if(dir == "down"){
                        if(primeiroBloco.direction == "left" || primeiroBloco.direction == "right")
                            primeiroBloco.direction = "down";
                    }
                    else if(dir == "left"){
                        if(primeiroBloco.direction == "up" || primeiroBloco.direction == "down")
                            primeiroBloco.direction = "left";
                    }
                    else if(dir == "right"){
                        if(primeiroBloco.direction == "up" || primeiroBloco.direction == "down")
                            primeiroBloco.direction = "right";
                    }
                }
            };
            
            var comida = {
                x: -100,
                y: -100,
                tempoRestante: -1,
                
                atualiza: function(){
                    this.tempoRestante -= time;
                },
                    
                desenha: function(){
                    ctx.fillStyle = "red";
                    ctx.fillRect(this.x, this.y, larguraBloco, alturaBloco);
                }
            };
            
			document.addEventListener("keydown", function(e) {
                if(estado == estados.jogando){
                    if(e.keyCode == 39) snake.changeDirection("right");
                    else if(e.keyCode == 40) snake.changeDirection("down");
                    else if(e.keyCode == 37) snake.changeDirection("left");
                    else if(e.keyCode == 38) snake.changeDirection("up");
                }
                else if(estado == estados.telaInicial){
                    if(e.keyCode == 13)
                        estado = estados.jogando;
                }
                else if(estado == estados.perdeu){
                    if(e.keyCode == 13){
                        reset();
                        estado = estados.jogando;
                    }
                }
			});
            
            function atualiza(){
                if(estado == estados.jogando){
                    snake.atualiza();
                    comida.atualiza();
                    if(comida.tempoRestante < 0){
                        comida.x = 10 + Math.floor(580 * Math.random());
                        comida.y = 10 + Math.floor(580 * Math.random());
                        comida.tempoRestante = (time * 100) + Math.floor(time * 25 * Math.random());
                    }
                }
            }
			
			function desenha() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                if(estado == estados.jogando){
                    snake.desenha();
                    comida.desenha();
                    
                    ctx.fillStyle = "black";
                    ctx.font = "25px Verdana";
                    ctx.fillText(score, 10, 30);
                }
                else if(estado == estados.telaInicial){
                    ctx.fillStyle = "green";
                    ctx.beginPath();
                    var x = 300;
                    var y = 300;
                    var radius = 128;
                    var anticlockwise = true;
                    var startAngle = 0;
                    var endAngle = Math.PI*2;
                    ctx.arc(x, y, radius, startAngle, endAngle, anticlockwise);
                    ctx.closePath();
                    ctx.stroke();
                    ctx.fill();
                    
                    ctx.fillStyle = "white";
                    ctx.font = "25px Verdana";
                    ctx.fillText("Pressione <enter>", 185, 295);
                    ctx.fillText("para jogar!", 230, 335);
                }
                else if(estado == estados.perdeu){
                    snake.desenha();
                    
                    ctx.fillStyle = "red";
                    ctx.fillRect(175, 225, 250, 150);
                    
                    ctx.fillStyle = "white";
                    ctx.font = "25px Verdana";
                    ctx.fillText("Você perdeu!", 220, 265);
                    
                    ctx.font = "22px Verdana";
                    if(score == -1){
                        if(recorde < 100)
                            ctx.fillText("Novo recorde: " + recorde, 205, 300);
                        else if(recorde < 1000)
                            ctx.fillText("Novo recorde: " + recorde, 195, 300);
                        else
                            ctx.fillText("Novo recorde: " + recorde, 188, 300);
                    } else {
                        if(recorde < 100)
                            ctx.fillText("Recorde atual: " + recorde, 205, 300);
                        else if(recorde < 1000)
                            ctx.fillText("Recorde atual: " + recorde, 195, 300);
                        else
                            ctx.fillText("Recorde atual: " + recorde, 188, 300);
                        
                        ctx.fillStyle = "black";
                        ctx.font = "25px Verdana";
                        ctx.fillText(score, 10, 30);
                    }
                    
                    ctx.font = "16px Verdana";
                    ctx.fillText("Pressione <enter> para jogar", 180, 370);
                }
			}
			
            function reset(){
                snake.blocos = [];
                score = 0;
                time = 70;
                comida.tempoRestante = -1;
            }
            
            function main(){
                if(snake.blocos.length == 0){
                    for(var i = 0; i < 7; i++)
                        snake.insereBloco();
                    
                    recorde = localStorage.getItem("recorde-snake");
                    if(recorde == null)
                        recorde = 0;
                }
                
                atualiza();
                desenha();
                
                setTimeout(main, time);
            }
            
            estado = estados.telaInicial;
            main();
		</script>
	</body>
</html>